name: "CycloneDX SBOM action"
description: "Generate CycloneDX SBOM with Syft"

inputs:
  image:
    required: true
    description: "The Docker image to scan."
    # i.e: "example/image_name:tag"
  filename:
    required: true
    description: "The generated SBOM file name"
  upload-artifact:
    required: false
    description: "Attach the SBOM to the workflow"
    default: "true"
  upload-release-assets:
    required: false
    description: "Attach the SBOM to the release"
    default: "true"
  syft-version:
    required: false
    description: "Syft version"
    default: v0.105.0
  registry-username:
      required: false
      type: string
      description: "Registry username"
  registry-password:
      required: false
      type: string
      description: "Registry password"

runs:
  using: "composite"
  steps:
    - uses: anchore/sbom-action@f8bdd1d8ac5e901a77a92f111440fdb1b593736b # v0.20.6
      with:
        image: ${{ inputs.image }}
        artifact-name: ${{ inputs.filename }}
        output-file: ${{ inputs.filename }}
        format: cyclonedx-json
        syft-version: ${{ inputs.syft-version }}
        upload-artifact: ${{ inputs.upload-artifact }}
        upload-release-assets: ${{ inputs.upload-release-assets }}
        registry-username: ${{ inputs.registry-username }}
        registry-password: ${{ inputs.registry-password }}
      env:
        SYFT_QUIET: true
    - name: Sign CycloneDX SBOM
      if: inputs.upload-artifact == 'true' && env.GPG_PRIVATE_KEY_PASSPHRASE && env.GPG_PRIVATE_KEY_BASE64
      shell: bash
      env:
        SBOM_FILENAME: ${{ inputs.filename }}
      run: |
        export GNUPGHOMEDIR=gnupg/
        mkdir --parent "${GNUPGHOMEDIR}"
        echo "${GPG_PRIVATE_KEY_PASSPHRASE}" | gpg --batch --pinentry-mode loopback --passphrase-fd 0 --quiet --import <(echo "${GPG_PRIVATE_KEY_BASE64}")
        echo "${GPG_PRIVATE_KEY_PASSPHRASE}" | gpg --batch --pinentry-mode loopback --passphrase-fd 0 --quiet --detach-sign --armor "$SBOM_FILENAME"
        rm -rf "${GNUPGHOMEDIR}"
    - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      if: inputs.upload-artifact == 'true'
      with:
        name: "${{ inputs.filename }}"
        path: |
          ${{ inputs.filename }}
          ${{ inputs.filename }}.asc
        overwrite: true
    - name: Upload binaries to release
      if: inputs.upload-release-assets == 'true' && startsWith(github.ref, 'refs/tags/')
      uses: svenstaro/upload-release-action@81c65b7cd4de9b2570615ce3aad67a41de5b1a13 # v2
      with:
        repo_token: ${{ github.token }}
        file_glob: true
        file: "${{ inputs.filename }}?(.asc)"
        tag: ${{ github.ref }}
        overwrite: true
